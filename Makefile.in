CC := gcc -std=c99
CFLAGS := -Wall -Wextra
DEBUG := -g
OPT :=
COPTIONS = $(CFLAGS) $(DEBUG) $(OPT)
DEPFLAGS = -MMD -MP -MT $@ -MF $(DEPDIR)/$*.d

LD := gcc
LINKOPTIONS = $(DEBUG) -shared -Wl,-soname,$(LIBFILE).$(MAJOR_VERSION)
LDFLAGS := -lm

INSTALL := cp -p
UNINSTALL := rm -f
AR := ar -crs
MKDIR := mkdir -pv
RMDIR := rm -r
LDCONFIG := ldconfig


LIBFILE = lib$(LIBNAME)$(TYPESUFFIX)$(LIBEXT)
SUFFIXES := $(FLOAT_SUFFIX) $(DOUBLE_SUFFIX) $(LONG_SUFFIX)
EXTS := $(STATIC_EXT) $(SHARED_EXT)
LIBNAMES := $(addprefix lib$(LIBNAME),$(SUFFIXES))
LIBFILES := $(foreach libfile,$(LIBNAMES), $(addprefix $(libfile),$(EXTS) ) )

SHELL := /bin/bash

INSTALL_LIBDIR := $(PREFIX)/lib
INSTALL_HEADERDIR := $(PREFIX)/include

float%: TYPESUFFIX := $(FLOAT_SUFFIX)
double%: TYPESUFFIX := $(DOUBLE_SUFFIX)
long%: TYPESUFFIX := $(LONG_SUFFIX)
%static: LIBEXT := $(STATIC_EXT)
%shared: LIBEXT := $(SHARED_EXT)


.SECONDEXPANSION:


#################################################
# building libs
#################################################

SRCS := $(wildcard $(SRCDIR)/*.c)
SRCNAMES := $(notdir $(SRCS))
OBJNAMES := $(SRCNAMES:.c=.o)
DEPNAMES := $(SRCNAMES:.c=.d)
DEPS := $(addprefix $(DEPDIR)/,$(DEPNAMES) )

FLOAT_TARGETS := $(filter float%,$(TARGETS) )
DOUBLE_TARGETS := $(filter double%,$(TARGETS) )
LONG_TARGETS := $(filter long%,$(TARGETS) )
STATIC_TARGETS := $(filter %static,$(TARGETS) )
SHARED_TARGETS := $(filter %shared,$(TARGETS) )
TARGETDIRS := $(addprefix $(BUILDDIR)/,$(TARGETS) )
DEPTARGETDIRS := $(addprefix $(DEPDIR)/,$(TARGETS) )
DEPFILES := \
	$(foreach DEPTAR,$(DEPTARGETDIRS), $(addprefix $(DEPTAR)/,$(DEPNAMES) ) )
MAKEDIRS := $(BUILDDIR) $(DEPDIR) $(TARGETDIRS) $(DEPTARGETDIRS)


.PHONY: all float double long static shared static-all shared-all $(TARGETS)
all: $(TARGETS)
float: float-$(DEFAULT_LIB)
double: double-$(DEFAULT_LIB)
long: long-$(DEFAULT_LIB)
static: $(DEFAULT_TYPE)-static
shared: $(DEFAULT_TYPE)-shared
float-all: $(FLOAT_TARGETS)
double-all: $(DOUBLE_TARGETS)
long-all: $(LONG_TARGETS)
static-all: $(STATIC_TARGETS)
shared-all: $(SHARED_TARGETS)

$(FLOAT_TARGETS): CFLAGS += -DFLOAT
$(FLOAT_TARGETS): TARGETDIR := float
$(DOUBLE_TARGETS): CFLAGS += -DDOUBLE
$(DOUBLE_TARGETS): TARGETDIR := double
$(LONG_TARGETS): CFLAGS += -DLONG
$(LONG_TARGETS): TARGETDIR := long

$(STATIC_TARGETS): TARGETDIR := $(TARGETDIR)-static
$(STATIC_TARGETS): CREATELIB = $(AR) $(LIBFILE) $(OBJNAMES)

$(SHARED_TARGETS): CFLAGS += -fpic
$(SHARED_TARGETS): TARGETDIR := $(TARGETDIR)-shared
$(SHARED_TARGETS): CREATELIB = $(LD) $(LINKOPTIONS) $(OBJNAMES) -o \
	$(LIBFILE).$(VERSION) $(LDFLAGS)

$(TARGETS): $$(addprefix $(BUILDDIR)/$$(TARGETDIR)/,$(OBJNAMES) ) $$(LIBFILE)

$(LIBFILES):
	@cd $(BUILDDIR)/$(TARGETDIR) && $(CREATELIB)
	@echo "cd $(BUILDDIR)/$(TARGETDIR) && $(CREATELIB)"

$(BUILDDIR)/%.o: $(SRCDIR)/$$(*F).c | $(DEPDIR)/$$(*D) $(BUILDDIR)/$$(*D)
	@$(CC) $(COPTIONS) -MM -MT $@ -MP -MF $(DEPDIR)/$*.d $<
	$(CC) $(COPTIONS) -c -o $@ $<

-include $(DEPFILES)


$(MAKEDIRS):
	@$(MKDIR) $@


#################################################
# clean build and dep directories
#################################################

CLEAN_TARGETS := $(addprefix clean-,$(TARGETS) )
CLEAN_FLOAT := $(addprefix clean-,$(FLOAT_TARGETS) )
CLEAN_DOUBLE := $(addprefix clean-,$(DOUBLE_TARGETS) )
CLEAN_LONG := $(addprefix clean-,$(LONG_TARGETS) )
CLEAN_STATIC := $(addprefix clean-,$(STATIC_TARGETS) )
CLEAN_SHARED := $(addprefix clean-,$(SHARED_TARGETS) )

.PHONY: clean clean-all clean-float clean-double clean-long \
	clean-static clean-shared $(CLEAN_TARGETS)
clean clean-all: $(CLEAN_TARGETS)
clean-float: $(CLEAN_FLOAT)
clean-double: $(CLEAN_DOUBLE)
clean-long: $(CLEAN_LONG)
clean-static: $(CLEAN_STATIC)
clean-shared: $(CLEAN_SHARED)

$(CLEAN_TARGETS):
	@if [ -d $(DEPDIR)/$(patsubst clean-%,%,$@) ]; then \
		echo "$(RMDIR) $(DEPDIR)/$(patsubst clean-%,%,$@)"; \
		$(RMDIR) $(DEPDIR)/$(patsubst clean-%,%,$@); \
		if [ -z "$$(ls -A $(DEPDIR))" ]; then \
			echo "$(RMDIR) $(DEPDIR)"; \
			$(RMDIR) $(DEPDIR); \
		fi \
	fi
	@if [ -d $(BUILDDIR)/$(patsubst clean-%,%,$@) ]; then \
		echo "$(RMDIR) $(BUILDDIR)/$(patsubst clean-%,%,$@)"; \
		$(RMDIR) $(BUILDDIR)/$(patsubst clean-%,%,$@); \
		if [ -z "$$(ls -A $(BUILDDIR))" ]; then \
			echo "$(RMDIR) $(BUILDDIR)"; \
			$(RMDIR) $(BUILDDIR); \
		fi \
	fi


#################################################
# install library
#################################################

INSTALL_TARGETS := $(addprefix install-,$(TARGETS) )
INSTALL_FLOATS := $(addprefix install-,$(FLOAT_TARGETS) )
INSTALL_DOUBLE := $(addprefix install-,$(DOUBLE_TARGETS) )
INSTALL_LONG := $(addprefix install-,$(LONG_TARGETS) )
INSTALL_STATIC := $(addprefix install-,$(STATIC_TARGETS) )
INSTALL_SHARED := $(addprefix install-,$(SHARED_TARGETS) )

.PHONY: install install-all install-float install-double install-long \
	install-static install-shared $(INSTALL_TARGETS)
install install-all: $(INSTALL_TARGETS)
install-float: LIB := $(LIB)f
install-float: $(INSTALL_FLOAT)
install-double: $(INSTALL_DOUBLE)
install-long: $(INSTALL_LONG)
install-static: $(INSTALL_STATIC)
install-shared: $(INSTALL_SHARED)

$(INSTALL_TARGETS): | $(INSTALL_LIBDIR) $(INSTALL_HEADERDIR)
	@if [ -d $(BUILDDIR)/$(patsubst install-%,%,$@) ]; then \
		if [ -n "$(filter %static,$@)" ]; then \
			echo $(INSTALL) \
			"$$(ls -A $(BUILDDIR)/$(patsubst install-%,%,$@)/$(LIBFILE))" \
			$(INSTALL_LIBDIR) \
			; \
			$(INSTALL) \
			"$$(ls -A $(BUILDDIR)/$(patsubst install-%,%,$@)/$(LIBFILE))" \
			$(INSTALL_LIBDIR) \
			; \
		elif [ -n "$(filter %shared,$@)" ]; then \
			echo $(INSTALL) \
			"$$(ls -A $(BUILDDIR)/$(patsubst install-%,%,$@)/$(LIBFILE).$(VERSION))" \
			$(INSTALL_LIBDIR) \
			; \
			$(INSTALL) \
			"$$(ls -A $(BUILDDIR)/$(patsubst install-%,%,$@)/$(LIBFILE).$(VERSION))" \
			$(INSTALL_LIBDIR) \
			; \
			echo "cd $(INSTALL_LIBDIR) &&"\
			"ln -fs $(LIBFILE).$(VERSION) $(LIBFILE)" \
			; \
			cd $(INSTALL_LIBDIR) && ln -fs $(LIBFILE).$(VERSION) $(LIBFILE); \
			echo $(LDCONFIG) -n $(INSTALL_LIBDIR); \
			$(LDCONFIG) -n $(INSTALL_LIBDIR); \
		fi \
	fi
	@if [ ! -f $(INSTALL_HEADERDIR)/$(HEADER) ]; then \
		echo $(INSTALL) $(HEADER) $(INSTALL_HEADERDIR) ;\
		$(INSTALL) $(HEADER) $(INSTALL_HEADERDIR) ;\
	fi


$(INSTALL_LIBDIR) $(INSTALL_HEADERDIR):
	@$(MKDIR) $@


#################################################
# uninstall libraries
#################################################

UNINSTALL_TARGETS := $(addprefix uninstall-,$(TARGETS) )
UNINSTALL-FLOAT := $(addprefix uninstall-,$(FLOAT_TARGETS) )
UNINSTALL_DOUBLE := $(addprefix uninstall-,$(DOUBLE_TARGETS) )
UNINSTALL_LONG := $(addprefix uninstall-,$(LONG_TARGETS) )
UNINSTALL_STATIC := $(addprefix uninstall-,$(STATIC_TARGETS) )
UNINSTALL_SHARED := $(addprefix uninstall-,$(SHARED_TARGETS) )

.PHONY: uninstall uninstall-all uninstall-float uninstall-double \
	uninstall-long uninstall-static uninstall-shared $(UNINSTALL_TARGETS)
uninstall uninstall-all: $(UNINSTALL_TARGETS)
uninstall-float: $(UNINSTALL_FLOAT)
uninstall-double: $(UNINSTALL_DOUBLE)
uninstall-long: $(UNINSTALL_LONG)
uninstall-static: $(UNINSTALL_STATIC)
uninstall-shared: $(UNINSTALL_shared)

$(UNINSTALL_TARGETS):
	@if [ -f $(INSTALL_LIBDIR)/$(LIBFILE) ]; then \
		echo $(UNINSTALL) $(INSTALL_LIBDIR)/$(LIBFILE) ;\
		$(UNINSTALL) $(INSTALL_LIBDIR)/$(LIBFILE) ;\
		if [ -n "$(filter %shared,$@)" ]; then \
			echo $(UNINSTALL) $(INSTALL_LIBDIR)/$(LIBFILE).$(VERSION) ;\
			$(UNINSTALL) $(INSTALL_LIBDIR)/$(LIBFILE).$(VERSION) ;\
		fi \
	fi
	@if [ -z "$(ls $(INSTALL_LIBDIR)/libftu*)" ]; then \
		if [ -f $(INSTALL_HEADERDIR)/$(HEADER) ]; then \
			echo $(UNINSTALL) $(INSTALL_HEADERDIR)/$(HEADER) ;\
			$(UNINSTALL) $(INSTALL_HEADERDIR)/$(HEADER) ;\
		fi \
	fi
